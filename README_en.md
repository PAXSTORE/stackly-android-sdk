# PAX Stackly

## OverView

Stackly PAX's professional quality tracking service for Android development, including crash monitoring and crash analysis. Bugly can help mobile Internet developers to find and control abnormalities in a timely manner, understand the abnormalities in a more comprehensive manner, and fix and resolve abnormalities more efficiently. 

The Stackly system consists of two parts: the backend server and the Android SDK.

## Purpose

This document introduces the basic functions and configuration methods of the modules provided by the Stacklytics SDK, and provides programming reference for developers. The functional interface provided by the Stackly SDK is to provide methods for APPs to report crashes, custom exceptions, and ANR. The purpose is to let app developers not have to care about the reporting logic of app exceptions, only the exception itself.

## Features

- java crash report
- customer fileds
- report policy configuration
- ANR report
- native crash report
- upload custom event

 Please take care of your AppKey and AppSecret that generated by PAXSTORE system when you create an app.
<br>Refer to the following steps for integration.

## Requirements
**Android SDK version**

>SDK 19 or higher, depending on the terminal's paydroid version.

**Gradle's and Gradle plugin's version**
>Gradle version 4.1 or higher  
>Gradle plugin version 3.0.0+ or higher

## Download
Gradle:

```groovy
implementation 'com.pax.vas.stacklytics:stacklytics-android-sdk:1.3.0'
```


## Permissions
Stacklytics need the following permissions, please add them in AndroidManifest.xml.

```JAVA
<uses-permission android:name="android.permission.INTERNET" />
<permission android:name="android.permission.READ_LOGS" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
```

## API Usage

### Step 1: Get Application Key and Secret
Create a new app in PAXSTORE, and get **AppKey** and **AppSecret** from app detail page in developer center.

### Step 2: Initialization
Configuring the application element, edit AndroidManifest.xml, it will have an application element. You need to configure the android:name attribute to point to your Application class (put the full name with package if the application class package is not the same as manifest root element declared package)

Configure Stackly Access Key, the key is the Access Key applied for on the paxstore.


```JAVA
<application
    android:name=".BaseApplication"
    android:allowBackup="true"
    android:icon="@mipmap/ic_launcher"
    android:label="@string/app_name"
    android:theme="@style/AppTheme">
        
   <meta-data android:name="Stackly_Access_Key" android:value="xxx"/>
```

Initializing AppSecret and ALIAS
>Please note, make sure that you have correctly placed the alias and AppSecret of your own application and replaced it with your sn or this other device identifier

```JAVA
public class BaseApplication extends Application implements PackReportData {
    private static final String TAG = BaseApplication.class.getSimpleName();

    //todo make sure to replace with your own app's appSecret and alias
    private String APP_SECRET = "Your APPSECRET";
    private String ALIAS = Build.SERIAL;

    @Override
    protected void attachBaseContext(Context base) {
        super.attachBaseContext(base);
      Stacklytics.I.install(this)
                .setReportSenderListener(new ReportSenderListener<CrashReportData>() {
                    @Override
                    public void onSendStart() {
                        Log.d(TAG, "onSendStart");
                    }

                    @Override
                    public boolean bypass(CrashReportData crashReportData) {
                        Log.d(TAG, "bypass");
                        return false;
                    }


                    @Override
                    public void onSendCompleted() {
                        Log.d(TAG, "onSendCompleted");
                    }

                    @Override
                    public void onSendError(Throwable throwable) {
                        Log.d(TAG, "onSendError");
                    }
                })
                .setSecret(APP_SECRET)//set your secret
                .setAlias(ALIAS)//set your alias
                .init();
    }
    
     //Get the exception report data, you can customize it and return the json string
    @Override
    public String getReportContent(CrashReportData crashReportData) {
        return "{\"REPORT_ID\":\"1234\"}";
    }
}
```
### Step 3: Use case

```java
public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }
    
    @Override
    protected void onResume() {
        super.onResume();
        handleSingleEvent();
        handleMultipleEvent();
    }

    //Send a single event
    private void handleSingleEvent() {
        Map<String, String> paramMap = new HashMap<>();
        paramMap.put("key1", "value1");
        EventInfo eventInfo = EventInfo.newBuilder().setEventId("eventId1").setEventTime(System.currentTimeMillis()).setParam(paramMap).build();
        try {
            Stacklytics.handleEvent(eventInfo);
        } catch (EventFailedException e) {
            e.printStackTrace();
        }
    }

    //Send multiple events
    private void handleMultipleEvent() {
        Map<String, String> paramMap = new HashMap<>();
        paramMap.put("key1", "value1");
        EventInfo eventInfo = EventInfo.newBuilder().setEventId("eventId1").setEventTime(System.currentTimeMillis()).setParam(paramMap).build();

        Map<String, String> secondParamMap = new HashMap<>();
        secondParamMap.put("key2", "value2");
        EventInfo secondEventInfo = EventInfo.newBuilder().setEventId("eventId2").setEventTime(System.currentTimeMillis()).setParam(secondParamMap).build();

        List<EventInfo> eventInfoList = new ArrayList<>();
        eventInfoList.add(eventInfo);
        eventInfoList.add(secondEventInfo);

        try {
            Stacklytics.handleEvent(eventInfoList);
        } catch (EventFailedException e) {
            e.printStackTrace();
        }
    }
}

```

## Apis

com.pax.vas.stacklytics.reporter.Stacklytics

### Get   instance

```java
Stacklytics.I
```

### Install  Stacklytics

```java
public Stacklytics install(Application application) {}
```

| Parameter   | Type        | Description |
| ----------- | ----------- | ----------- |
| application | Application | Application |

### Set  secret

```JAVA
public Stacklytics setSecret(String secret) {}
```

| Parameter | Type   | Description |
| --------- | ------ | ----------- |
| secret    | String | Secret      |

### Set   Alias

```java
public Stacklytics setAlias(String alias) {}
```

| Parameter | Type   | Description             |
| --------- | ------ | ----------------------- |
| serialNo  | String | The alias of the device |

### Init        Initialize operation, and finally call

```
public void init()
```

### Set   AnrCount

```java
 public void setAnrCount(int anrCount) {}
```

| Parameter | Type | Description                                      |
| --------- | ---- | ------------------------------------------------ |
| anrCount  | Int  | The number of log rows collected when anr occurs |

### Set formUri

REQUEST_URI :   /pdc/stacklytics/api/app_client/crash_report

```java
public Stacklytics setFormUri(String formUri) {}
```

| Parameter | Type   | Description                                                  |
| --------- | ------ | ------------------------------------------------------------ |
| formUri   | String | The uri collected by your own log will be combined with REQUEST_URI to form a complete address |

### Set to skip init

```java
public Stacklytics bypassInit(boolean bypassInit) {}
```

| Parameter  | Type    | Description                                                  |
| ---------- | ------- | ------------------------------------------------------------ |
| bypassInit | Boolean | Set to skip init, which means that the crash will not be uploaded and generally used for debugging |

### Enable DevLog

```java
public Stacklytics enableDevLog(boolean enable) {}
```

| Parameter | Type    | Description          |
| --------- | ------- | -------------------- |
| enable    | Boolean | Whether to print log |

### Watch ANR

```java
public Stacklytics watchANR(boolean watchANR) {}
```

| Parameter | Type    | Description            |
| --------- | ------- | ---------------------- |
| watchANR  | Boolean | Whether to collect Anr |

### Watch Native

```java
public Stacklytics watchNative(boolean watchNative) {}
```

| Parameter   | Type    | Description                     |
| ----------- | ------- | ------------------------------- |
| watchNative | Boolean | Whether to collect native crash |

### Set SpFileName

```java
public Stacklytics setSpFileName(String spFileName) {}
```

| Parameter  | Type   | Description                                |
| ---------- | ------ | ------------------------------------------ |
| spFileName | String | Set the file name for saving configuration |

### Put  Custom  Error  Report  Data

```java
public Stacklytics putCustomErrorReportData(String key, String value) {}
```

| Parameter | Type   | Description |
| --------- | ------ | ----------- |
| key       | String | Data key    |
| value     | String | Data value  |

### Contains Custom Data Key

```java
public boolean containsCustomDataKey(String key) {}
```

| Parameter | Type   | Description                |
| --------- | ------ | -------------------------- |
| key       | String | Custom Data exist this key |

### Set Custom Pack Data

```java
public Stacklytics setCustomPackData(PackReportData customPackData) {}
```

| Parameter      | Type           | Description                                                  |
| -------------- | -------------- | ------------------------------------------------------------ |
| customPackData | PackReportData | Custom combination data ,  Instance  of implementing PackReportData |

### PackReportData

```java
public interface PackReportData {
    public String getReportContent(CrashReportData report);
}
```

| Parameter | Type            | Description                                          |
| --------- | --------------- | ---------------------------------------------------- |
| report    | CrashReportData | According to CrashReportData  combined into a string |

### SetReportSenderListener

```java
public Stacklytics setReportSenderListener(ReportSenderListener<CrashReportData> senderListener) {}
```

| Parameter      | Type                                                 | Description                     |
| -------------- | ---------------------------------------------------- | ------------------------------- |
| senderListener | ReportSenderListener<CrashReportData> senderListener | Crash report data send listener |

```java
setReportSenderListener(new ReportSenderListener<CrashReportData>() {
    @Override
    public void onSendStart() {
        Log.d(TAG, "onSendStart");
    }

    @Override
    public boolean bypass(CrashReportData crashReportData) {
        Log.d(TAG, "bypass");
        return false;
    }


    @Override
    public void onSendCompleted() {
        Log.d(TAG, "onSendCompleted");

    }

    @Override
    public void onSendError(Throwable throwable) {
        Log.d(TAG, "onSendError");
    }
})
```

### Send a single custom event

```java
public static void handleEvent(EventInfo eventInfo) throws EventFailedException {
}
```

| Parameter | Type      | Description  |
| --------- | --------- | ------------ |
| eventInfo | EventInfo | Single event |

### Send multiple custom events

```java
public static void handleEvent(List<EventInfo> eventInfoList) throws EventFailedException {
}
```

| Parameter     | Type            | Description |
| ------------- | --------------- | ----------- |
| eventInfoList | List<EventInfo> | Event list  |

### EventInfo

```java
new EventInfo.Builder().setEventId(eventid).setEventTime(eventtime).setParam(param).build()
```

| Parameter | Type                | Description                                    |
| --------- | ------------------- | ---------------------------------------------- |
| eventId   | String              | The id of event                                |
| eventTime | long                | Time when the event occurred (ms)              |
| param     | Map<String, String> | Parameter key-value pairs that need to be sent |

## Migrating to Android 8.0

Since Android 8.0 has lots of changes that will affect your app's behavior, we recommand you to follow the guide to migrate
to Android 8.0. For further information, you can refer to https://developer.android.google.cn/about/versions/oreo/android-8.0-migration


## FAQ

#### 1. How to resolve dependencies conflict?

When dependencies conflict occur, the error message may like below:

    Program type already present: xxx.xxx.xxx

**Solution:**

You can use **exclude()** method to exclude the conflict dependencies by **group** or **module** or **both**.

e.g. To exclude 'com.google.code.gson:gson:2.8.5' in SDK, you can use below:

    implementation ('com.pax.vas.stacklytics:stacklytics-android-sdk:x.xx.xx'){
        exclude group: 'com.google.code.gson', module: 'gson'
    }

#### 2. How to resolve attribute conflict?

When attribute conflict occur, the error message may like below:

    Manifest merger failed : Attribute application@allowBackup value=(false) from 
    AndroidManifest.xml...
    is also present at [stacklytics:x.xx.xx] 
    AndroidManifest.xml...
    Suggestion: add 'tools:replace="android:allowBackup"' to <application> element
    at AndroidManifest.xml:..

**Solution:**

Add **xmlns:tools="http\://<span></span>schemas.android.com/tools"** in your manifest header

       <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.yourpackage"
            xmlns:tools="http://schemas.android.com/tools">

Add **tools:replace = "the confilct attribute"** to your application tag:

        <application
            ...
            tools:replace="allowBackup"/>


More questions, please refer to [FAQ](https://github.com/PAXSTORE/paxstore-3rd-app-android-sdk/wiki/FAQ)

## License

See the [Apache 2.0 license](https://github.com/PAXSTORE/paxstore-3rd-app-android-sdk/blob/master/LICENSE) file for details.

    Copyright 2018 PAX Computer Technology(Shenzhen) CO., LTD ("PAX")
    
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at following link.
    
         http://www.apache.org/licenses/LICENSE-2.0
    
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
